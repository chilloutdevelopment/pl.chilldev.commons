<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>AbstractApplication.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">ChillDev Commons Service</a> &gt; <a href="../index.html" class="el_bundle">commons-jsonrpc</a> &gt; <a href="index.source.html" class="el_package">pl.chilldev.commons.jsonrpc.daemon</a> &gt; <span class="el_source">AbstractApplication.java</span></div><h1>AbstractApplication.java</h1><pre class="source lang-java linenums">// Generated by delombok at Sat Aug 27 09:26:47 UTC 2016
/**
 * This file is part of the ChillDev-Commons.
 *
 * @license http://mit-license.org/ The MIT license
 * @copyright 2015 - 2016 © by Rafał Wrzeszcz - Wrzasq.pl.
 */
package pl.chilldev.commons.jsonrpc.daemon;

import java.util.Collection;
import java.util.HashSet;
import io.netty.channel.EventLoopGroup;
import io.netty.channel.nio.NioEventLoopGroup;
import org.apache.commons.daemon.Daemon;
import org.apache.commons.daemon.DaemonContext;
import org.apache.commons.daemon.DaemonUserSignal;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/**
 * Base daemon application class.
 */
<span class="fc" id="L23">public abstract class AbstractApplication implements Daemon, DaemonUserSignal {</span>
    /**
     * Logger.
     */
<span class="fc" id="L27">    protected Logger logger = LoggerFactory.getLogger(AbstractApplication.class);</span>
    /**
     * List of children threads.
     */
<span class="fc" id="L31">    private Collection&lt;Listener&lt;?&gt;&gt; listeners = new HashSet&lt;&gt;();</span>
    /**
     * Acceptor threads.
     */
    private EventLoopGroup acceptors;
    /**
     * Worker threads.
     */
    private EventLoopGroup workers;
    /**
     * Acceptors thread count.
     */
    private int acceptorsCount;
    /**
     * Workers thread count.
     */
    private int workersCount;

    /**
     * Runs all listeners.
     */
    @Override
    public void start() {
<span class="fc" id="L54">        this.acceptors = new NioEventLoopGroup(this.acceptorsCount);</span>
<span class="fc" id="L55">        this.workers = new NioEventLoopGroup(this.workersCount);</span>
        // running threads
<span class="fc bfc" id="L57" title="All 2 branches covered.">        for (Listener&lt;?&gt; listener : this.buildListeners()) {</span>
            try {
<span class="fc" id="L59">                listener.start(this.acceptors, this.workers);</span>
<span class="fc" id="L60">                this.listeners.add(listener);</span>
<span class="fc" id="L61">            } catch (</span>
            //CHECKSTYLE:OFF: IllegalCatchCheck
            Exception error) {
                //CHECKSTYLE:ON: IllegalCatchCheck
<span class="fc" id="L65">                this.logger.error(&quot;Not starting \&quot;{}\&quot; because of {}.&quot;, listener.getName(), error.getMessage(), error);</span>
<span class="fc" id="L66">            }</span>
<span class="fc" id="L67">        }</span>
<span class="fc" id="L68">        this.logger.trace(&quot;Working.&quot;);</span>
<span class="fc" id="L69">    }</span>

    /**
     * Stops listeners.
     */
    @Override
    public void stop() {
<span class="fc" id="L76">        this.logger.info(&quot;Stopping…&quot;);</span>
        // wait for all listener
<span class="fc bfc" id="L78" title="All 2 branches covered.">        for (Listener&lt;?&gt; listener : this.listeners) {</span>
            try {
<span class="fc" id="L80">                listener.stop();</span>
<span class="fc" id="L81">            } catch (InterruptedException error) {</span>
<span class="fc" id="L82">                this.logger.error(&quot;Had to interrupt while waiting for thread \&quot;{}\&quot;.&quot;, listener.getName(), error);</span>
<span class="fc" id="L83">            }</span>
<span class="fc" id="L84">        }</span>
        // just to clean references
<span class="fc" id="L86">        this.listeners.clear();</span>
        // close thread pools
<span class="fc bfc" id="L88" title="All 2 branches covered.">        if (this.acceptors != null) {</span>
<span class="fc" id="L89">            this.acceptors.shutdownGracefully();</span>
        }
<span class="fc bfc" id="L91" title="All 2 branches covered.">        if (this.workers != null) {</span>
<span class="fc" id="L92">            this.workers.shutdownGracefully();</span>
        }
<span class="fc" id="L94">    }</span>

    /**
     * Just re-loads configuration.
     */
    @Override
    public void signal() {
<span class="fc" id="L101">        this.logger.info(&quot;Handling configuration reload.&quot;);</span>
        // no deep in-sight for now, but at least JVM bootstrapping is avoided
<span class="fc" id="L103">        this.stop();</span>
<span class="fc" id="L104">        this.start();</span>
<span class="fc" id="L105">    }</span>

    /**
     * Daemon resources initialization.
     *
     * @param context Runtime context for daemon.
     */
    @Override
    public void init(DaemonContext context) {
        // diagnostic info
<span class="fc" id="L115">        this.logger.info(&quot;Started {} daemon v.{} on {} {} ({}) / Java {} ({}).&quot;, new Object[] {this.getDaemonName(), this.getDaemonVersion(), System.getProperty(&quot;os.name&quot;), System.getProperty(&quot;os.version&quot;), System.getProperty(&quot;os.arch&quot;), System.getProperty(&quot;java.version&quot;), System.getProperty(&quot;java.vendor&quot;)});</span>
<span class="fc" id="L116">    }</span>

    /**
     * Daemon resources freeing.
     */
    @Override
    public void destroy() {
        // dummy method; not used - needed by org.apache.commons.daemon.Daemon
<span class="fc" id="L124">    }</span>

    /**
     * Returns daemon application name.
     *
     * @return String representation for information purpose.
     */
    protected abstract String getDaemonName();

    /**
     * Returns daemon application version.
     *
     * @return String representation for information purpose.
     */
    protected abstract String getDaemonVersion();

    /**
     * Returns collection of listeners (not started, but instantiated).
     *
     * @return Collection of listeners to be started by the daemon.
     */
    protected abstract Collection&lt;Listener&lt;?&gt;&gt; buildListeners();

    /**
     * Acceptors thread count.
     */
    @SuppressWarnings(&quot;all&quot;)
    @javax.annotation.Generated(&quot;lombok&quot;)
    public void setAcceptorsCount(final int acceptorsCount) {
<span class="fc" id="L153">        this.acceptorsCount = acceptorsCount;</span>
<span class="fc" id="L154">    }</span>

    /**
     * Workers thread count.
     */
    @SuppressWarnings(&quot;all&quot;)
    @javax.annotation.Generated(&quot;lombok&quot;)
    public void setWorkersCount(final int workersCount) {
<span class="fc" id="L162">        this.workersCount = workersCount;</span>
<span class="fc" id="L163">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>