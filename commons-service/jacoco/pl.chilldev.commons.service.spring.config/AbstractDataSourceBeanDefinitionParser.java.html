<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AbstractDataSourceBeanDefinitionParser.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">ChillDev Commons Service</a> &gt; <a href="index.source.html" class="el_package">pl.chilldev.commons.service.spring.config</a> &gt; <span class="el_source">AbstractDataSourceBeanDefinitionParser.java</span></div><h1>AbstractDataSourceBeanDefinitionParser.java</h1><pre class="source lang-java linenums">/**
 * This file is part of the ChillDev-Commons.
 *
 * @license http://mit-license.org/ The MIT license
 * @copyright 2016 © by Rafał Wrzeszcz - Wrzasq.pl.
 */

package pl.chilldev.commons.service.spring.config;

import java.util.List;
import java.util.Properties;

import com.mchange.v2.c3p0.ComboPooledDataSource;

import org.springframework.beans.MutablePropertyValues;
import org.springframework.beans.factory.config.BeanDefinition;
import org.springframework.beans.factory.config.RuntimeBeanReference;
import org.springframework.beans.factory.support.BeanDefinitionRegistry;
import org.springframework.beans.factory.support.GenericBeanDefinition;
import org.springframework.beans.factory.xml.BeanDefinitionParser;
import org.springframework.beans.factory.xml.ParserContext;

import org.springframework.data.jpa.repository.support.JpaRepositoryFactory;

import org.springframework.orm.jpa.JpaTransactionManager;
import org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean;
import org.springframework.orm.jpa.SharedEntityManagerCreator;
import org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter;

import org.w3c.dom.Element;

/**
 * Data source (entire set of beans related to entities and transactions as well) definition handler.
 */
<span class="fc" id="L35">public abstract class AbstractDataSourceBeanDefinitionParser</span>
    implements BeanDefinitionParser
{
    /**
     * Transaction manager bean name prefix.
     */
    public static final String BEANNAME_TRANSACTIONMANAGER = &quot;transactionManager&quot;;

    /**
     * Bean name separator.
     */
    public static final String SEPARATOR_BEANNAME = &quot;:&quot;;

    /**
     * `name=&quot;&quot;` attribute.
     */
    protected static final String ATTRIBUTE_NAME = &quot;name&quot;;

    /**
     * `driverClass=&quot;&quot;` attribute.
     */
    private static final String ATTRIBUTE_DRIVERCLASS = &quot;driverClass&quot;;

    /**
     * `jdbcUrl=&quot;&quot;` attribute.
     */
    private static final String ATTRIBUTE_JDBCURL = &quot;jdbcUrl&quot;;

    /**
     * `user=&quot;&quot;` attribute.
     */
    private static final String ATTRIBUTE_USER = &quot;user&quot;;

    /**
     * `password=&quot;&quot;` attribute.
     */
    private static final String ATTRIBUTE_PASSWORD = &quot;password&quot;;

    /**
     * `acquireIncrement=&quot;&quot;` attribute.
     */
    private static final String ATTRIBUTE_ACQUIREINCREMENT = &quot;acquireIncrement&quot;;

    /**
     * `minPoolSize=&quot;&quot;` attribute.
     */
    private static final String ATTRIBUTE_MINPOOLSIZE = &quot;minPoolSize&quot;;

    /**
     * `maxPoolSize=&quot;&quot;` attribute.
     */
    private static final String ATTRIBUTE_MAXPOOLSIZE = &quot;maxPoolSize&quot;;

    /**
     * `maxIdleTime=&quot;&quot;` attribute.
     */
    private static final String ATTRIBUTE_MAXIDLETIME = &quot;maxIdleTime&quot;;

    /**
     * `initialPoolSize=&quot;&quot;` attribute.
     */
    private static final String ATTRIBUTE_INITIALPOOLSIZE = &quot;initialPoolSize&quot;;

    /**
     * `hibernateDialect=&quot;&quot;` attribute.
     */
    private static final String ATTRIBUTE_HIBERNATEDIALECT = &quot;hibernateDialect&quot;;

    /**
     * `hibernateJdbcBatchSize=&quot;&quot;` attribute.
     */
    private static final String ATTRIBUTE_HIBERNATEJDBCBATCHSIZE = &quot;hibernateJdbcBatchSize&quot;;

    //CHECKSTYLE:OFF: MultipleStringLiteralsCheck
    /**
     * Data source bean name prefix.
     */
    private static final String BEANNAME_DATASOURCE = &quot;dataSource&quot;;
    //CHECKSTYLE:ON: MultipleStringLiteralsCheck

    /**
     * Entity manager factory bean name prefix.
     */
    private static final String BEANNAME_ENTITYMANAGERFACTORY = &quot;entityManagerFactory&quot;;

    /**
     * Entity manager bean name prefix.
     */
    private static final String BEANNAME_ENTITYMANAGER = &quot;entityManager&quot;;

    /**
     * Repository factory bean name prefix.
     */
    private static final String BEANNAME_REPOSITORYFACTORY = &quot;repositoryFactory&quot;;

    /**
     * `createSharedEntityManager()` factory method name.
     */
    private static final String METHOD_CREATESHAREDENTITYMANAGER = &quot;createSharedEntityManager&quot;;

    /**
     * `getRepository()` factory method name.
     */
    private static final String METHOD_GETREPOSITORY = &quot;getRepository&quot;;

    /**
     * `persistenceUnitName` property name.
     */
    private static final String PROPERTY_PERSISTENCEUNITNAME = &quot;persistenceUnitName&quot;;

    /**
     * `dataSource` property name.
     */
    //CHECKSTYLE:OFF: MultipleStringLiteralsCheck
    private static final String PROPERTY_DATASOURCE = &quot;dataSource&quot;;
    //CHECKSTYLE:ON: MultipleStringLiteralsCheck

    /**
     * `packagesToScan` property name.
     */
    private static final String PROPERTY_PACKAGESTOSCAN = &quot;packagesToScan&quot;;

    /**
     * `jpaVendorAdapter` property name.
     */
    private static final String PROPERTY_JPAVENDORADAPTER = &quot;jpaVendorAdapter&quot;;

    /**
     * `hibernate.hbm2ddl.auto` property name.
     */
    private static final String PROPERTY_HIBERNATEHBM2DDLAUTO = &quot;hibernate.hbm2ddl.auto&quot;;

    /**
     * `hibernate.dialect` property name.
     */
    private static final String PROPERTY_HIBERNATEDIALECT = &quot;hibernate.dialect&quot;;

    /**
     * `hibernate.jdbc.batch_size` property name.
     */
    private static final String PROPERTY_HIBERNATEJDBCBATCHSIZE = &quot;hibernate.jdbc.batch_size&quot;;

    /**
     * `jpaProperties` property name.
     */
    private static final String PROPERTY_JPAPROPERTIES = &quot;jpaProperties&quot;;

    /**
     * {@inheritDoc}
     */
    @Override
    public BeanDefinition parse(Element element, ParserContext parserContext)
    {
<span class="fc" id="L188">        String name = element.getAttribute(AbstractDataSourceBeanDefinitionParser.ATTRIBUTE_NAME);</span>
<span class="fc" id="L189">        BeanDefinitionRegistry registry = parserContext.getRegistry();</span>

        // build all beans
<span class="fc" id="L192">        registry.registerBeanDefinition(</span>
            AbstractDataSourceBeanDefinitionParser.BEANNAME_DATASOURCE
                + AbstractDataSourceBeanDefinitionParser.SEPARATOR_BEANNAME
                + name,
<span class="fc" id="L196">            this.createDataSourceBeanDefinition(element)</span>
        );
<span class="fc" id="L198">        registry.registerBeanDefinition(</span>
            AbstractDataSourceBeanDefinitionParser.BEANNAME_ENTITYMANAGERFACTORY
                + AbstractDataSourceBeanDefinitionParser.SEPARATOR_BEANNAME
                + name,
<span class="fc" id="L202">            this.createEntityManagerFactoryBeanDefinition(name, element)</span>
        );
<span class="fc" id="L204">        registry.registerBeanDefinition(</span>
            AbstractDataSourceBeanDefinitionParser.BEANNAME_ENTITYMANAGER
                + AbstractDataSourceBeanDefinitionParser.SEPARATOR_BEANNAME
                + name,
<span class="fc" id="L208">            this.createEntityManagerBeanDefinition(name)</span>
        );
<span class="fc" id="L210">        registry.registerBeanDefinition(</span>
            AbstractDataSourceBeanDefinitionParser.BEANNAME_REPOSITORYFACTORY
                + AbstractDataSourceBeanDefinitionParser.SEPARATOR_BEANNAME
                + name,
<span class="fc" id="L214">            this.createRepositoryFactoryBeanDefinition(name)</span>
        );
<span class="fc" id="L216">        registry.registerBeanDefinition(</span>
            AbstractDataSourceBeanDefinitionParser.BEANNAME_TRANSACTIONMANAGER
                + AbstractDataSourceBeanDefinitionParser.SEPARATOR_BEANNAME
                + name,
<span class="fc" id="L220">            this.createTransactionManagerBeanDefinition(name)</span>
        );

<span class="fc" id="L223">        return null;</span>
    }

    /**
     * Builds data source bean.
     *
     * @param element Configuration options parsed from XML.
     * @return Bean definition.
     */
    private BeanDefinition createDataSourceBeanDefinition(Element element)
    {
        // JDBC connection pool with C3P0
<span class="fc" id="L235">        GenericBeanDefinition bean = new GenericBeanDefinition();</span>
<span class="fc" id="L236">        bean.setBeanClass(ComboPooledDataSource.class);</span>

<span class="fc" id="L238">        MutablePropertyValues properties = bean.getPropertyValues();</span>
<span class="fc" id="L239">        properties.addPropertyValue(</span>
            AbstractDataSourceBeanDefinitionParser.ATTRIBUTE_DRIVERCLASS,
<span class="fc" id="L241">            element.getAttribute(AbstractDataSourceBeanDefinitionParser.ATTRIBUTE_DRIVERCLASS)</span>
        );
<span class="fc" id="L243">        properties.addPropertyValue(</span>
            AbstractDataSourceBeanDefinitionParser.ATTRIBUTE_JDBCURL,
<span class="fc" id="L245">            element.getAttribute(AbstractDataSourceBeanDefinitionParser.ATTRIBUTE_JDBCURL)</span>
        );
<span class="fc bfc" id="L247" title="All 2 branches covered.">        if (element.hasAttribute(AbstractDataSourceBeanDefinitionParser.ATTRIBUTE_USER)) {</span>
<span class="fc" id="L248">            properties.addPropertyValue(</span>
                AbstractDataSourceBeanDefinitionParser.ATTRIBUTE_USER,
<span class="fc" id="L250">                element.getAttribute(AbstractDataSourceBeanDefinitionParser.ATTRIBUTE_USER)</span>
            );
        }
<span class="fc bfc" id="L253" title="All 2 branches covered.">        if (element.hasAttribute(AbstractDataSourceBeanDefinitionParser.ATTRIBUTE_PASSWORD)) {</span>
<span class="fc" id="L254">            properties.addPropertyValue(</span>
                AbstractDataSourceBeanDefinitionParser.ATTRIBUTE_PASSWORD,
<span class="fc" id="L256">                element.getAttribute(AbstractDataSourceBeanDefinitionParser.ATTRIBUTE_PASSWORD)</span>
            );
        }
<span class="fc" id="L259">        properties.addPropertyValue(</span>
            AbstractDataSourceBeanDefinitionParser.ATTRIBUTE_ACQUIREINCREMENT,
<span class="fc" id="L261">            element.getAttribute(AbstractDataSourceBeanDefinitionParser.ATTRIBUTE_ACQUIREINCREMENT)</span>
        );
<span class="fc" id="L263">        properties.addPropertyValue(</span>
            AbstractDataSourceBeanDefinitionParser.ATTRIBUTE_MINPOOLSIZE,
<span class="fc" id="L265">            element.getAttribute(AbstractDataSourceBeanDefinitionParser.ATTRIBUTE_MINPOOLSIZE)</span>
        );
<span class="fc" id="L267">        properties.addPropertyValue(</span>
            AbstractDataSourceBeanDefinitionParser.ATTRIBUTE_MAXPOOLSIZE,
<span class="fc" id="L269">            element.getAttribute(AbstractDataSourceBeanDefinitionParser.ATTRIBUTE_MAXPOOLSIZE)</span>
        );
<span class="fc" id="L271">        properties.addPropertyValue(</span>
            AbstractDataSourceBeanDefinitionParser.ATTRIBUTE_MAXIDLETIME,
<span class="fc" id="L273">            element.getAttribute(AbstractDataSourceBeanDefinitionParser.ATTRIBUTE_MAXIDLETIME)</span>
        );
<span class="fc" id="L275">        properties.addPropertyValue(</span>
            AbstractDataSourceBeanDefinitionParser.ATTRIBUTE_INITIALPOOLSIZE,
<span class="fc" id="L277">            element.getAttribute(AbstractDataSourceBeanDefinitionParser.ATTRIBUTE_INITIALPOOLSIZE)</span>
        );

<span class="fc" id="L280">        return bean;</span>
    }

    /**
     * Builds entity manager factory bean.
     *
     * @param name Current scope name.
     * @param element Configuration options parsed from XML.
     * @return Bean definition.
     */
    private BeanDefinition createEntityManagerFactoryBeanDefinition(String name, Element element)
    {
        // Hibernate ORM
<span class="fc" id="L293">        GenericBeanDefinition bean = new GenericBeanDefinition();</span>
<span class="fc" id="L294">        bean.setBeanClass(LocalContainerEntityManagerFactoryBean.class);</span>

<span class="fc" id="L296">        MutablePropertyValues properties = bean.getPropertyValues();</span>
<span class="fc" id="L297">        properties.addPropertyValue(</span>
            AbstractDataSourceBeanDefinitionParser.PROPERTY_PERSISTENCEUNITNAME,
            name
        );
<span class="fc" id="L301">        properties.addPropertyValue(</span>
            //CHECKSTYLE:OFF: MultipleStringLiteralsCheck
            AbstractDataSourceBeanDefinitionParser.PROPERTY_DATASOURCE,
            //CHECKSTYLE:ON: MultipleStringLiteralsCheck
            new RuntimeBeanReference(AbstractDataSourceBeanDefinitionParser.BEANNAME_DATASOURCE
                + AbstractDataSourceBeanDefinitionParser.SEPARATOR_BEANNAME
                + name)
        );

<span class="fc" id="L310">        properties.addPropertyValue(</span>
            AbstractDataSourceBeanDefinitionParser.PROPERTY_PACKAGESTOSCAN,
<span class="fc" id="L312">            this.getPackagesToScan()</span>
        );

        // build vendor adapter bean
<span class="fc" id="L316">        GenericBeanDefinition jpaVendorAdapterBean = new GenericBeanDefinition();</span>
<span class="fc" id="L317">        jpaVendorAdapterBean.setBeanClass(HibernateJpaVendorAdapter.class);</span>
<span class="fc" id="L318">        properties.addPropertyValue(</span>
            AbstractDataSourceBeanDefinitionParser.PROPERTY_JPAVENDORADAPTER,
            jpaVendorAdapterBean
        );

        // JPA properties
<span class="fc" id="L324">        Properties jpaProperties = new Properties();</span>
<span class="fc" id="L325">        jpaProperties.setProperty(</span>
            AbstractDataSourceBeanDefinitionParser.PROPERTY_HIBERNATEHBM2DDLAUTO,
            &quot;update&quot; //TODO: will probably change
        );
<span class="fc" id="L329">        jpaProperties.setProperty(</span>
            AbstractDataSourceBeanDefinitionParser.PROPERTY_HIBERNATEDIALECT,
<span class="fc" id="L331">            element.getAttribute(AbstractDataSourceBeanDefinitionParser.ATTRIBUTE_HIBERNATEDIALECT)</span>
        );
<span class="fc" id="L333">        jpaProperties.setProperty(</span>
            AbstractDataSourceBeanDefinitionParser.PROPERTY_HIBERNATEJDBCBATCHSIZE,
<span class="fc" id="L335">            element.getAttribute(AbstractDataSourceBeanDefinitionParser.ATTRIBUTE_HIBERNATEJDBCBATCHSIZE)</span>
        );
<span class="fc" id="L337">        properties.addPropertyValue(</span>
            AbstractDataSourceBeanDefinitionParser.PROPERTY_JPAPROPERTIES,
            jpaProperties
        );

<span class="fc" id="L342">        return bean;</span>
    }

    /**
     * Builds entity manager bean.
     *
     * @param name Current scope name.
     * @return Bean definition.
     */
    private BeanDefinition createEntityManagerBeanDefinition(String name)
    {
        // entity manager used directly in the code
<span class="fc" id="L354">        GenericBeanDefinition bean = new GenericBeanDefinition();</span>
<span class="fc" id="L355">        bean.setBeanClass(SharedEntityManagerCreator.class);</span>
<span class="fc" id="L356">        bean.setFactoryMethodName(AbstractDataSourceBeanDefinitionParser.METHOD_CREATESHAREDENTITYMANAGER);</span>
<span class="fc" id="L357">        bean.getConstructorArgumentValues().addGenericArgumentValue(</span>
            new RuntimeBeanReference(AbstractDataSourceBeanDefinitionParser.BEANNAME_ENTITYMANAGERFACTORY
                + AbstractDataSourceBeanDefinitionParser.SEPARATOR_BEANNAME
                + name)
        );

<span class="fc" id="L363">        return bean;</span>
    }

    /**
     * Builds repository factory bean.
     *
     * @param name Current scope name.
     * @return Bean definition.
     */
    private BeanDefinition createRepositoryFactoryBeanDefinition(String name)
    {
        // for by-hand JPA repositories creation
<span class="fc" id="L375">        GenericBeanDefinition bean = new GenericBeanDefinition();</span>
<span class="fc" id="L376">        bean.setBeanClass(JpaRepositoryFactory.class);</span>
<span class="fc" id="L377">        bean.getConstructorArgumentValues().addGenericArgumentValue(</span>
            new RuntimeBeanReference(AbstractDataSourceBeanDefinitionParser.BEANNAME_ENTITYMANAGER
                + AbstractDataSourceBeanDefinitionParser.SEPARATOR_BEANNAME
                + name)
        );

<span class="fc" id="L383">        return bean;</span>
    }

    /**
     * Builds transaction manager bean.
     *
     * @param name Current scope name.
     * @return Bean definition.
     */
    private BeanDefinition createTransactionManagerBeanDefinition(String name)
    {
        // JPA transactions manager
<span class="fc" id="L395">        GenericBeanDefinition bean = new GenericBeanDefinition();</span>
<span class="fc" id="L396">        bean.setBeanClass(JpaTransactionManager.class);</span>
<span class="fc" id="L397">        bean.getConstructorArgumentValues().addGenericArgumentValue(</span>
            new RuntimeBeanReference(AbstractDataSourceBeanDefinitionParser.BEANNAME_ENTITYMANAGERFACTORY
                + AbstractDataSourceBeanDefinitionParser.SEPARATOR_BEANNAME
                + name)
        );

<span class="fc" id="L403">        return bean;</span>
    }

    /**
     * Builds typed repository bean.
     *
     * @param name Current scope name.
     * @param type Repository type.
     * @return Bean definition.
     */
    protected BeanDefinition createRepositoryBeanDefinition(String name, Class&lt;?&gt; type)
    {
        // entity repository type
<span class="fc" id="L416">        GenericBeanDefinition bean = new GenericBeanDefinition();</span>
<span class="fc" id="L417">        bean.setFactoryBeanName(</span>
            AbstractDataSourceBeanDefinitionParser.BEANNAME_REPOSITORYFACTORY
                + AbstractDataSourceBeanDefinitionParser.SEPARATOR_BEANNAME
                + name
        );
<span class="fc" id="L422">        bean.setFactoryMethodName(AbstractDataSourceBeanDefinitionParser.METHOD_GETREPOSITORY);</span>
<span class="fc" id="L423">        bean.getConstructorArgumentValues().addGenericArgumentValue(type);</span>

<span class="fc" id="L425">        return bean;</span>
    }

    /**
     * Returns list of Java packages to scan for Hibernate/JPA annotated entities.
     *
     * @return List of package names.
     */
    protected abstract List&lt;String&gt; getPackagesToScan();
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>