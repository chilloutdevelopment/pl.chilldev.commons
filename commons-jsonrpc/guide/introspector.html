
<!DOCTYPE html>
<!--
 Generated by Apache Maven Doxia at 2015-12-18
 Rendered using Reflow Maven Skin 1.1.1 (http://andriusvelykis.github.io/reflow-maven-skin)
-->
<html  xml:lang="en" lang="en">

	<head>
		<meta charset="UTF-8" />
		<title>ChillDev Commons JSON-RPC &#x2013; Service introspector</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<meta name="description" content="" />
		<meta http-equiv="content-language" content="en" />

		<link href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap.min.css" rel="stylesheet" />
		<link href="../css/docs.css" rel="stylesheet" />
		<link href="../css/reflow-skin.css" rel="stylesheet" />

		<link href="http://yandex.st/highlightjs/7.5/styles/default.min.css" rel="stylesheet" />

		<link href="../css/lightbox.css" rel="stylesheet" />

		<link href="../css/site.css" rel="stylesheet" />
		<link href="../css/print.css" rel="stylesheet" media="print" />

		<!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
		<!--[if lt IE 9]>
			<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
		<![endif]-->



	</head>

	<body class="page-guide-introspector project-commons-jsonrpc" data-spy="scroll" data-offset="60" data-target="#toc-scroll-target">

		<div class="navbar navbar-fixed-top">
			<div class="navbar-inner">
				<div class="container">
					<a class="btn btn-navbar" data-toggle="collapse" data-target="#top-nav-collapse">
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
					</a>
					<a class="brand" href="http://chilldev.pl"><img src="http://static.chilldev.pl/images/chilldevpl.png" alt="Chillout Development"/></a>
					<div class="nav-collapse collapse" id="top-nav-collapse">
						<ul class="nav pull-right">
							<li class="dropdown">
								<a href="#" class="dropdown-toggle" data-toggle="dropdown">Main <b class="caret"></b></a>
								<ul class="dropdown-menu">
									<li ><a href="https://github.com/chilloutdevelopment/pl.chilldev.commons/" title="GitHub project" class="externalLink">GitHub project</a></li>
									<li ><a href="http://chilldev.pl/" title="Chillout Development" class="externalLink">Chillout Development</a></li>
									<li ><a href="http://wrzasq.pl/" title="Wrzasq.pl" class="externalLink">Wrzasq.pl</a></li>
									<li ><a href="https://www.facebook.com/chilldev" title="ChillDev @ Facebook" class="externalLink">ChillDev @ Facebook</a></li>
									<li ><a href="https://www.facebook.com/wrzasqpl" title="Wrzasq.pl @ Facebook" class="externalLink">Wrzasq.pl @ Facebook</a></li>
								</ul>
							</li>
							<li class="dropdown">
								<a href="#" class="dropdown-toggle" data-toggle="dropdown">Parent Project <b class="caret"></b></a>
								<ul class="dropdown-menu">
									<li ><a href="../../index.html" title="ChillDev Commons">ChillDev Commons</a></li>
								</ul>
							</li>
							<li class="dropdown active">
								<a href="#" class="dropdown-toggle" data-toggle="dropdown">Guide <b class="caret"></b></a>
								<ul class="dropdown-menu">
									<li ><a href="rpc.html" title="JSON-RPC - dispatcher">JSON-RPC - dispatcher</a></li>
									<li class="active"><a href="" title="JSON-RPC - introspector">JSON-RPC - introspector</a></li>
									<li ><a href="mina.html" title="Mina I/O">Mina I/O</a></li>
									<li ><a href="listener.html" title="Building listener">Building listener</a></li>
									<li ><a href="daemon.html" title="Building daemon">Building daemon</a></li>
									<li ><a href="client.html" title="Building client">Building client</a></li>
									<li ><a href="json.html" title="JSON extras">JSON extras</a></li>
								</ul>
							</li>
							<li class="dropdown">
								<a href="#" class="dropdown-toggle" data-toggle="dropdown">Project Documentation <b class="caret"></b></a>
								<ul class="dropdown-menu">
									<li class="dropdown-submenu ">
										<a href="../project-info.html" title="Project Information">Project Information</a>
										<ul class="dropdown-menu">
											<li ><a href="../integration.html" title="Continuous Integration">Continuous Integration</a></li>
											<li ><a href="../dependencies.html" title="Dependencies">Dependencies</a></li>
											<li ><a href="../dependency-info.html" title="Dependency Information">Dependency Information</a></li>
											<li ><a href="../distribution-management.html" title="Distribution Management">Distribution Management</a></li>
											<li ><a href="../index.html" title="About">About</a></li>
											<li ><a href="../issue-tracking.html" title="Issue Tracking">Issue Tracking</a></li>
											<li ><a href="../license.html" title="Project License">Project License</a></li>
											<li ><a href="../plugin-management.html" title="Plugin Management">Plugin Management</a></li>
											<li ><a href="../plugins.html" title="Project Plugins">Project Plugins</a></li>
											<li ><a href="../team-list.html" title="Project Team">Project Team</a></li>
											<li ><a href="../source-repository.html" title="Source Repository">Source Repository</a></li>
											<li ><a href="../project-summary.html" title="Project Summary">Project Summary</a></li>
										</ul>
									</li>
									<li class="dropdown-submenu ">
										<a href="../project-reports.html" title="Project Reports">Project Reports</a>
										<ul class="dropdown-menu">
											<li ><a href="../checkstyle.html" title="Checkstyle">Checkstyle</a></li>
											<li ><a href="../dependency-analysis.html" title="Dependency Analysis">Dependency Analysis</a></li>
											<li ><a href="../apidocs/index.html" title="JavaDocs">JavaDocs</a></li>
											<li ><a href="../xref/index.html" title="Source Xref">Source Xref</a></li>
											<li ><a href="../surefire-report.html" title="Surefire Report">Surefire Report</a></li>
											<li ><a href="../findbugs.html" title="FindBugs">FindBugs</a></li>
										</ul>
									</li>
								</ul>
							</li>
						</ul>
					</div><!--/.nav-collapse -->
				</div>
			</div>
		</div>

	<div class="container">

	<!-- Masthead
	================================================== -->

	<header>
	<div class="jumbotron subhead">
		<div class="row" id="banner">
			<div class="span12">
				<div class="pull-left">
					<div id="bannerLeft"><h1>ChillDev Commons</h1></div>
				</div>
				<div class="pull-right">
					<a href="http://wrzasq.pl" id="bannerRight"><h1><img src="http://static.wrzasq.pl/images/wrzasqpl.png" alt="Wrzasq.pl"/></h1></a>
				</div>
			</div>
		</div>
	</div>
	</header>

	<div class="main-body">
	<div class="row">
		<div class="span12">
			<div class="body-content">
<!-- -
# This file is part of the ChillDev-Commons.
#
# @license http://mit-license.org/ The MIT license
# @copyright 2015 © by Rafał Wrzeszcz - Wrzasq.pl. --> 
<div class="page-header">
 <h1>Service introspector</h1>
</div> 
<p>With all the knowledge about how the dispatcher work, we can go step further and cover all of that with the introspection mechanism that will compose the dispatcher for us. For that we will have to use <tt>pl.chilldev.commons.jsonrpc.rpc.introspector.Introspector</tt> class. It takes the class, looks for all it’s methods that are annotated with <tt>pl.chilldev.commons.jsonrpc.rpc.introspector.JsonRpcCall</tt> annotation and registers request handler for every such method. The logic here is as follows:</p> 
<ul> 
 <li>method handler is registered in the dispatcher with the same name (possible to change via annotation);</li> 
 <li>for each method argument an RPC argument resolver is registered matching it’s type;</li> 
 <li>arguments resolving is done based on method arguments names (possible to change via annotation);</li> 
 <li>method result is returned as a response (possible to be post-processed, unless <tt>void</tt>);</li> 
 <li><tt>JSONRPC2Error</tt> exceptions are exposed directly through respose, others are wrapped with <tt>JSONRPC2Error.INTERNAL_ERROR</tt>.</li> 
</ul> 
<p><b>Note:</b> As arguments resolving is by default done based on their names, your code needs to be compiled with <tt>-parameters</tt> argument to expose parameters names at runtime via reflection API. Otherwise you will have to explicitly define names for all arguments through annotations.</p> 
<p>In order to use introspector, you first need to create a facade class (or interface) that will describe the API you want to expose in your dispatcher:</p> 
<div class="source"> 
 <div class="source"> 
  <pre>import pl.chilldev.commons.jsonrpc.rpc.introspector.JsonRpcCall;

public interface ApiFacade
{
    @JsonRpcCall
    public String getPath(UUID id);

    // name property of the annotation allows you to override the JSON-RPC method name
    @JsonRpcCall(name = &quot;getPathByName&quot;)
    public String getPath(String name);

    // note lack of @JsonRpcCall annotation - this method won't be exposed
    public String getPath();
}
</pre> 
 </div> 
</div> 
<p>Once you have the class/interface, you may use introspector to populate the disptcher:</p> 
<div class="source"> 
 <div class="source"> 
  <pre>import pl.chilldev.commons.jsonrpc.rpc.Dispatcher;
import pl.chilldev.commons.jsonrpc.rpc.introspector.Introspector;

public class DispatcherFactory
{
    public Dispatcher&lt;ApiFacade&gt; createDispatcher()
    {
        Dispatcher&lt;ApiFacade&gt; dispatcher = new Dispatcher&lt;&gt;();

        Introspector.DEFAULT_INTROSPECTOR.register(ApiFacade.class, dispatcher);

        // you can register owne method handlers

        return dispatcher;
    }
}
</pre> 
 </div> 
</div> 
<p><b>Note:</b> Introspector just populates the dispatcher, you can register own request handlers in the same dispatcher as well.</p> 
<div class="section"> 
 <h2 id="Fine-tuning_parameters">Fine-tuning parameters</h2> 
 <p>Apart from <tt>@JsonRpcCall</tt> annotation there is a second one, <tt>@JsonRpcParam</tt>, which allows for defining detailed metadata for each of the method parameters.</p> 
 <p><b>Note:</b> By default each method parameter is mendatory, however default status of <tt>optional</tt> flag of <tt>@JsonRpcParam</tt> annotation is <tt>true</tt>, so using this annotation on it’s own automatically makes parameter optional.</p> 
 <p>The annotation has four attributes:</p> 
 <ul> 
  <li><tt>String name</tt> - can be used to override parameter name in JSON-RPC signature;</li> 
  <li><tt>boolean optional</tt> - optionality flag;</li> 
  <li><tt>String defaultValue</tt> - default value of the parameter (if optional) - due to <b>Java</b> limitations it must always be a <tt>String</tt>;</li> 
  <li><tt>boolean defaultNull</tt> - use this flag to set default parameter value to <tt>null</tt>, it has a precedence over <tt>defaultValue</tt> (it’s introduced because of another <b>Java</b> stupid limitation, that annotation properties may not have <tt>null</tt> values).</li> 
 </ul> 
 <div class="source"> 
  <div class="source"> 
   <pre>import pl.chilldev.commons.jsonrpc.rpc.introspector.JsonRpcCall;
import pl.chilldev.commons.jsonrpc.rpc.introspector.JsonRpcParam;

public interface ApiFacade
{
    @JsonRpcCall
    public String calculateHash(
        // this one is mendatory, this is the default behavior
        String base,
        // this one is optional, default value is true
        @JsonRpcParam(defaultValue = &quot;true&quot;) boolean optionalBool,
        // this one is explicitely mendatory and fetched by different name
        @JsonRpcParam(name = &quot;name&quot;, optional = false) String id,
        // this one is optional and by default it's null
        @JsonRpcParam(defaultNull = true) String optionalString
    );
}
</pre> 
  </div> 
 </div> 
</div> 
<div class="section"> 
 <h2 id="Parameters_providers">Parameters providers</h2> 
 <p>To handle method argument, a parameter provider needs to be registered for it’s type. Parameter provider is responsible for retrieving parameter value from request based on it’s name (and additional information, like default value).</p> 
 <p>Parameter provider takes four arguments:</p> 
 <ol style="list-style-type: decimal"> 
  <li>request parameter name;</li> 
  <li>request parameters retriever;</li> 
  <li>optionality flag;</li> 
  <li>default value as a <tt>String</tt>.</li> 
 </ol> 
 <div class="source"> 
  <div class="source"> 
   <pre>introspector.registerParameterProvider(
    YourType.class
    (String name, ParamsRetriever params, boolean optional, String defaultValue) -&gt; {
        String value = optional ? params.getOptString(name, defaultValue) : params.getString(name);
        return YourType::fromString(value);
    }
);
</pre> 
  </div> 
 </div> 
 <p>Because of <b>Java</b> limitations regarding annotations, <tt>defaultValue</tt> will be a <tt>java.lang.String</tt> (may be <tt>null</tt>), you must decide on your own how to represent it in your type.</p> 
 <p><b>Note:</b> You have to register parameter provider before using introspector on your facade.</p> 
 <p><b>Note:</b> If any of arguments of your facade won’t have registered provider, introspector will throw exception on attempt to register that facade.</p> 
</div> 
<div class="section"> 
 <h2 id="Response_mappers">Response mappers</h2> 
 <p>It is also possible to register mappers for post-processing your response. It’s mainly usable if you don’t want to design your facades especially for <b>JSON-RPC</b> protocol and want to expose your standard methods that may return complex types. For instance standard introspector is capable of dumping <tt>org.springframework.data.domain.Page</tt> objects as a JSON-able structure.</p> 
 <p>Response type mapper is a simple mapping function that maps single argument (which is the invoked method result) into another value (that will be assigned as JSON-RPC response). It is also registered based on it’s type:</p> 
 <div class="source"> 
  <div class="source"> 
   <pre>introspector.registerResultMapper(
    YourEntity.class,
    (YourEntity entity) -&gt; new YourTransferPojo(entity)
);
</pre> 
  </div> 
 </div> 
 <p><b>Note:</b> You have to register results mapper before using introspector on your facade.</p> 
 <h1>Client introspector</h1> 
 <p>Similar mechanism exists for the client-side classes. All you have to do is to define an interface (can be also an abstract class) the maps to service methods (you even use same annotations):</p> 
 <div class="source"> 
  <div class="source"> 
   <pre>import java.util.List;
import java.util.UUID;

import pl.chilldev.commons.jsonrpc.rpc.introspector.JsonRpcCall;
import pl.chilldev.commons.jsonrpc.rpc.introspector.JsonRpcParam;

public interface MyClient
{
    @JsonRpcCall
    String getName(UUID id);

    @JsonRpcCall(name = &quot;getNameByEmail&quot;);
    String getName(String email);

    @JsonRpcCall
    List&lt;String&gt; getNames(@JsonRpcParam(name = &quot;ids&quot;) List&lt;UUID&gt; list);
}
</pre> 
  </div> 
 </div> 
 <p><tt>@JsonRpcCall</tt> annotation plays similar role that in the service introspector - it marks the method to be handled by the proxy interceptor and invoke the service method. It’s additional <tt>name</tt> attribute allows you to change the actual invoked RPC method (by default it’s same as method name).</p> 
 <p>Arguments are mapped by their names and it can also be changed by using <tt>name</tt> attribute of <tt>@JsonRpcParam</tt> annotation.</p> 
 <p><b>Note:</b> As all <b>JSON-RPC</b> mechanisms are handled internally, you don’t need to worry about connector anymore - you simply don’t need it.</p> 
 <p><b>Note:</b> Currently only public methods are handled, however it doesn’t matter if they are defined directly in a class or inherited.</p> 
 <p>Not only interfaces are allowed, but also classes, so you can define additional methods that are not mapped to RPC calls. It’s especially useful for handling custom, more complicated data types. For instance paged response results need requested page, so this is how we commonly solve the issue:</p> 
 <div class="source"> 
  <div class="source"> 
   <pre>import java.util.List;

import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;

import pl.chilldev.commons.jsonrpc.json.ConvertUtils;
import pl.chilldev.commons.jsonrpc.rpc.introspector.JsonRpcCall;

public abstract class MyClient
{
    @JsonRpcCall(name = &quot;getPage&quot;)
    public abstract List&lt;Object&gt; doGetPage(Pageable request);

    public Page&lt;MyEntity&gt; getPage(Pageable request)
    {
        return ConvertUtils.buildPage(
            this.doGetPage(request),
            request,
            MyEntity.class
        );
    }
}
</pre> 
  </div> 
 </div> 
</div> 
<div class="section"> 
 <h2 id="Instantiating_the_client">Instantiating the client</h2> 
 <p>Ok, so we don’t need to define the logic, all the errorneus and tedious work is done for us. But how to get the actual client instance? That’s what you need <tt>pl.chilldev.commons.jsonrpc.client.introspector.Introspector</tt> for (note the different package name than for the service introspector).</p> 
 <div class="source"> 
  <div class="source"> 
   <pre>import pl.chilldev.commons.jsonrpc.client.introspector.Introspector;

// connector is an instance of pl.chilldev.commons.jsonrpc.client.Connector
MyClient client = Introspector.DEFAULT_INTROSPECTOR.createClient(MyClient.class, connector);

System.out.println(client.getName(&quot;test@localhost&quot;));
</pre> 
  </div> 
 </div> 
</div> 
<div class="section"> 
 <h2 id="Parameters_mappers">Parameters mappers</h2> 
 <p>By default all parameters are passed as-they-are to the JSON dumper and they dumped into JSON structure (all non-standard JSON types are dumped by using their <tt>.toString()</tt> method). <tt>Introspector.DEFAULT_INTROSPECTOR</tt> is also capable of handling <tt>org.springframework.data.domain.Pageable</tt> objects (they are dumped as three parameters for page number, page size and sorting criteria, the standard format supported by <tt>commons-jsonrpc</tt> stack. If you want to handle custom parameters in a different way, you can register own parameter mappers. A parameter mapper takes method parameter name, parameter value and current state of request params and is responsible for putting new parameter into the parameter map.</p> 
 <div class="source"> 
  <div class="source"> 
   <pre>introspector.registerParameterMapper(
    UUID.class,
    (String name, UUID value, Map&lt;String, Object&gt; params) -&gt; {
        params.put(name, value.toString());
    }
);
</pre> 
  </div> 
 </div> 
 <p><b>Note:</b> Such mapper is not needed as all objects are dumped with <tt>.toString()</tt> by default.</p> 
</div> 
<div class="section"> 
 <h2 id="Response_type_handlers">Response type handlers</h2> 
 <p>It’s also possible to handle custom response types. For example <tt>Introspector.DEFAULT_INTROSPECTOR</tt> is capable of returning (apart of standard JSON types) also instances of <tt>java.util.UUID</tt> parsed with <tt>UUID.fromString()</tt> method. You can register your own function for handling custom types:</p> 
 <div class="source"> 
  <div class="source"> 
   <pre>introspector.registerResultHandler(
    MyEntity.class,
    (Object response) -&gt; ParamsRetriever.OBJECT_MAPPER.convertValue(response, MyEntity.class)
);
</pre> 
  </div> 
 </div> 
</div>
			</div>
		</div>
	</div>
	</div>

	</div><!-- /container -->

	<!-- Footer
	================================================== -->
	<footer class="well">
		<div class="container">
			<div class="row">
				<div class="span3 bottom-nav">
					<ul class="nav nav-list">
						<li class="nav-header">Main</li>
						<li >
							<a href="https://github.com/chilloutdevelopment/pl.chilldev.commons/" title="GitHub project" class="externalLink">GitHub project</a>
						</li>
						<li >
							<a href="http://chilldev.pl/" title="Chillout Development" class="externalLink">Chillout Development</a>
						</li>
						<li >
							<a href="http://wrzasq.pl/" title="Wrzasq.pl" class="externalLink">Wrzasq.pl</a>
						</li>
						<li >
							<a href="https://www.facebook.com/chilldev" title="ChillDev @ Facebook" class="externalLink">ChillDev @ Facebook</a>
						</li>
						<li >
							<a href="https://www.facebook.com/wrzasqpl" title="Wrzasq.pl @ Facebook" class="externalLink">Wrzasq.pl @ Facebook</a>
						</li>
					</ul>
				</div>
				<div class="span3 bottom-nav">
					<ul class="nav nav-list">
						<li class="nav-header">Parent Project</li>
						<li >
							<a href="../../index.html" title="ChillDev Commons">ChillDev Commons</a>
						</li>
					</ul>
				</div>
				<div class="span3 bottom-nav">
					<ul class="nav nav-list">
						<li class="nav-header">Guide</li>
						<li >
							<a href="rpc.html" title="JSON-RPC - dispatcher">JSON-RPC - dispatcher</a>
						</li>
						<li class="active">
							<a href="#" title="JSON-RPC - introspector">JSON-RPC - introspector</a>
						</li>
						<li >
							<a href="mina.html" title="Mina I/O">Mina I/O</a>
						</li>
						<li >
							<a href="listener.html" title="Building listener">Building listener</a>
						</li>
						<li >
							<a href="daemon.html" title="Building daemon">Building daemon</a>
						</li>
						<li >
							<a href="client.html" title="Building client">Building client</a>
						</li>
						<li >
							<a href="json.html" title="JSON extras">JSON extras</a>
						</li>
					</ul>
				</div>
				<div class="span3 bottom-nav">
					<ul class="nav nav-list">
						<li class="nav-header">Project Documentation</li>
						<li >
							<a href="../project-info.html" title="Project Information">Project Information <i class="icon-chevron-right"></i></a>
						</li>
						<li >
							<a href="../project-reports.html" title="Project Reports">Project Reports <i class="icon-chevron-right"></i></a>
						</li>
					</ul>
				</div>
			</div>
		</div>
	</footer>

	<div class="container subfooter">
		<div class="row">
			<div class="span12">
				<p class="pull-right"><a href="#">Back to top</a></p>
				<p class="copyright">Copyright &copy;2015 <a href="http://wrzasq.pl/">Rafał Wrzeszcz - Wrzasq.pl</a>. All Rights Reserved.</p>
				<p class="version-date"><span class="projectVersion">Version: 0.1.1. </span><span class="publishDate">Last Published: 2015-12-18. </span></p>
				<p><a href="http://github.com/andriusvelykis/reflow-maven-skin" title="Reflow Maven skin">Reflow Maven skin</a> by <a href="http://andrius.velykis.lt" target="_blank" title="Andrius Velykis">Andrius Velykis</a>.</p>
			</div>
		</div>
	</div>

	<!-- Le javascript
	================================================== -->
	<!-- Placed at the end of the document so the pages load faster -->
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>

	<script src="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
	<script src="../js/lightbox.min.js"></script>
	<script src="../js/reflow-scroll.js"></script>
	<script src="http://yandex.st/highlightjs/7.5/highlight.min.js"></script>

	<script src="../js/reflow-skin.js"></script>

	</body>
</html>
